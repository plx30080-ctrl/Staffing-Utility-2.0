<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crescent Staffing Planner</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- SheetJS for XLSX export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 8px;
            font-size: 13px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            background: #f5f7ff;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }

        .firebase-status {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            z-index: 100;
        }

        .firebase-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .firebase-status-dot.connected {
            background: #10b981;
            box-shadow: 0 0 4px rgba(16, 185, 129, 0.5);
        }

        .firebase-status-dot.disconnected {
            background: #ef4444;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
        }

        .firebase-status-dot.offline {
            background: #f59e0b;
            box-shadow: 0 0 4px rgba(245, 158, 11, 0.5);
        }

        .cloud-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .cloud-badge.synced {
            background: #d1fae5;
            color: #065f46;
        }

        .cloud-badge.local-only {
            background: #fee2e2;
            color: #991b1b;
        }

        .content {
            padding: 16px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 8px 16px;
            background: none;
            border: none;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        /* Staffing Layout - Vertical Columns */
        .staffing-layout {
            display: flex;
            gap: 10px;
            height: calc(100vh - 200px);
            overflow: hidden;
        }

        .lines-container {
            flex: 1;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 12px;
            padding-right: 4px;
            scroll-behavior: smooth;
        }

        /* Better scrollbar styling */
        .lines-container::-webkit-scrollbar {
            height: 10px;
        }

        .lines-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }

        .lines-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        .lines-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .line-column {
            min-width: 160px;
            width: 200px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }

        .line-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: center;
            flex-shrink: 0;
        }

        .line-letter {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .line-lead {
            font-size: 11px;
            opacity: 0.95;
            line-height: 1.3;
            max-height: 40px;
            overflow-y: auto;
            overflow-x: hidden;
            word-wrap: break-word;
        }

        .line-stats {
            font-size: 10px;
            margin-top: 3px;
            opacity: 0.9;
        }

        .positions-list {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            scroll-behavior: smooth;
        }

        /* Better scrollbar for positions list */
        .positions-list::-webkit-scrollbar {
            width: 8px;
        }

        .positions-list::-webkit-scrollbar-track {
            background: #f9fafb;
        }

        .positions-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .positions-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .position-slot {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 6px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .position-slot:hover {
            border-color: #9ca3af;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .position-slot.filled {
            background: #ecfdf5;
            border-color: #10b981;
        }

        .position-slot.new-associate {
            background: #fef9c3;
            border-color: #eab308;
        }

        .position-number {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            min-width: 18px;
            flex-shrink: 0;
            text-align: center;
        }

        .position-input {
            flex: 1;
            padding: 5px 6px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 12px;
            min-width: 0;
        }

        .position-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .position-checkbox {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .position-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Waitlist Sidebar */
        .waitlist-sidebar {
            width: 200px;
            display: flex;
            flex-direction: column;
            background: #fffbeb;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .waitlist-header {
            background: #fbbf24;
            color: #78350f;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            font-size: 12px;
            flex-shrink: 0;
        }

        .waitlist-items {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            scroll-behavior: smooth;
        }

        /* Scrollbar for waitlist */
        .waitlist-items::-webkit-scrollbar {
            width: 8px;
        }

        .waitlist-items::-webkit-scrollbar-track {
            background: #fef9c3;
        }

        .waitlist-items::-webkit-scrollbar-thumb {
            background: #fbbf24;
            border-radius: 4px;
        }

        .waitlist-items::-webkit-scrollbar-thumb:hover {
            background: #f59e0b;
        }

        .waitlist-item {
            background: white;
            border: 1px solid #fbbf24;
            border-radius: 4px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .waitlist-input {
            width: 100%;
            padding: 5px 6px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 12px;
        }

        .waitlist-input:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.1);
        }

        .waitlist-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        .badge-new {
            background: #dbeafe;
            color: #1e40af;
        }

        .stats-bar {
            background: #f9fafb;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .save-status {
            font-size: 11px;
            color: #10b981;
            font-weight: 600;
        }

        /* Setup Form */
        .setup-form {
            display: grid;
            gap: 16px;
        }

        .form-section {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .form-section h3 {
            font-size: 16px;
            color: #111827;
            margin-bottom: 12px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Reporting View */
        .report-controls {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .report-list {
            display: grid;
            gap: 12px;
        }

        .report-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .report-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .report-item h4 {
            font-size: 14px;
            color: #111827;
            margin-bottom: 4px;
        }

        .report-item p {
            font-size: 12px;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state h3 {
            font-size: 16px;
            color: #374151;
            margin-bottom: 8px;
        }

        .core-associates-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .core-associate-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .core-associate-info {
            flex: 1;
        }

        .core-associate-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 2px;
            font-size: 13px;
        }

        .core-associate-flags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .flag-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        .flag-sitdown { background: #dbeafe; color: #1e40af; }
        .flag-sanitation { background: #fef3c7; color: #92400e; }
        .flag-office { background: #e9d5ff; color: #6b21a8; }
        .flag-high { background: #d1fae5; color: #065f46; }
        .flag-low { background: #fee2e2; color: #991b1b; }

        .flag-dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .flag-dropdown-button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .flag-dropdown-button:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .flag-dropdown-button:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .flag-dropdown-content {
            position: absolute;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 8px;
            z-index: 1000;
            min-width: 180px;
            top: 100%;
            left: 0;
            margin-top: 4px;
        }

        .flag-option {
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }

        .flag-option:hover {
            background: #f3f4f6;
        }

        .flag-option input[type="checkbox"] {
            cursor: pointer;
        }

        .filter-controls {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
        }

        .filter-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }

        .line-edit-controls {
            display: flex;
            gap: 4px;
            margin-top: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .line-edit-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 3px;
            font-size: 11px;
            margin-top: 4px;
            background: rgba(255,255,255,0.9);
        }

        .line-column.cut {
            opacity: 0.6;
            border-color: #ef4444;
            background: #fee2e2;
        }

        .line-column.cut .line-header {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .cut-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #dc2626;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            z-index: 10;
        }

        .position-slot.dragging {
            opacity: 0.4;
        }

        .position-slot.drag-over {
            background: #e0e7ff;
            border-color: #667eea;
            border-width: 2px;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .waitlist-item.dragging {
            opacity: 0.4;
        }

        .waitlist-item.drag-over {
            background: #e0e7ff;
            border-color: #667eea;
        }

        .drag-preview {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 4px;
            padding: 4px 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0.9;
            pointer-events: none;
            z-index: 9999;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-size: 12px;
            width: 180px;
        }

        .quick-add-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .quick-add-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .quick-add-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .quick-add-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }

        .quick-add-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .quick-add-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .quick-add-hint {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 16px;
        }

        .quick-add-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 16px;
        }

        .quick-add-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f9fafb;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .quick-add-item:last-child {
            margin-bottom: 0;
        }

        .search-box {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .lead-section {
            margin-bottom: 24px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .lead-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        .view-mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
        }

        .view-mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .view-mode-btn:hover:not(.active) {
            border-color: #667eea;
            color: #667eea;
        }

        .firebase-config {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .firebase-config h4 {
            color: #92400e;
            margin-bottom: 8px;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .staffing-layout {
                flex-direction: column;
                height: auto;
            }

            .lines-container {
                flex-direction: column;
                overflow-x: hidden;
                overflow-y: auto;
            }

            .line-column {
                max-width: 100%;
            }

            .waitlist-sidebar {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase configuration
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyD2ySRicFt2-Zd2JRaW0ZHHb97gzwgcdWg",
            authDomain: "staffingtool-1ab4f.firebaseapp.com",
            databaseURL: "https://staffingtool-1ab4f-default-rtdb.firebaseio.com",
            projectId: "staffingtool-1ab4f",
            storageBucket: "staffingtool-1ab4f.firebasestorage.app",
            messagingSenderId: "956290053379",
            appId: "1:956290053379:web:2611b6db69ef2c9b2de536",
            measurementId: "G-HFR8KR0HMQ"
        };

        let db = null;
        let isFirebaseConfigured = false;

        // Check if Firebase is configured
        try {
            const configuredKeys = Object.values(FIREBASE_CONFIG).filter(v => !v.startsWith('YOUR_'));
            if (configuredKeys.length === Object.keys(FIREBASE_CONFIG).length) {
                firebase.initializeApp(FIREBASE_CONFIG);
                db = firebase.database();  // Using Realtime Database instead of Firestore
                isFirebaseConfigured = true;
                console.log('Firebase Realtime Database initialized successfully');
            } else {
                console.warn('Firebase not configured. Using localStorage only.');
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Storage utilities
        const storage = {
            save: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            load: (key, defaultValue = null) => {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            },
            remove: (key) => localStorage.removeItem(key)
        };

        function App() {
            const [activeTab, setActiveTab] = useState('setup');
            const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
            const [currentShift, setCurrentShift] = useState('1st');
            const [lines, setLines] = useState([]);
            const [waitlist, setWaitlist] = useState([]);
            const [coreAssociates, setCoreAssociates] = useState({});
            const [saveStatus, setSaveStatus] = useState('');
            const [firebaseStatus, setFirebaseStatus] = useState(isFirebaseConfigured ? 'connected' : 'offline');
            const [isLocked, setIsLocked] = useState(false);
            const saveTimeoutRef = useRef(null);

            // Load core associates from Firebase and localStorage
            useEffect(() => {
                const loadCoreAssociates = async () => {
                    // Try Firebase first
                    if (isFirebaseConfigured && db) {
                        try {
                            const snapshot = await db.ref('settings/coreAssociates').once('value');
                            if (snapshot.exists()) {
                                const data = snapshot.val();
                                console.log('Loaded core associates from Firebase Realtime Database');
                                setCoreAssociates(data.associates || {});
                                return;
                            }
                        } catch (error) {
                            console.error('Error loading core associates from Firebase:', error);
                        }
                    }

                    // Fallback to localStorage
                    const savedCoreAssociates = storage.load('coreAssociates', {});
                    setCoreAssociates(savedCoreAssociates);
                };
                loadCoreAssociates();
            }, []);

            // Save core associates to both localStorage and Firebase
            useEffect(() => {
                storage.save('coreAssociates', coreAssociates);

                // Also save to Firebase
                if (isFirebaseConfigured && db && Object.keys(coreAssociates).length > 0) {
                    db.ref('settings/coreAssociates').set({
                        associates: coreAssociates,
                        lastUpdated: new Date().toISOString()
                    }).then(() => {
                        console.log('Core associates saved to Firebase Realtime Database');
                    }).catch(error => {
                        console.error('Error saving core associates to Firebase:', error);
                    });
                }
            }, [coreAssociates]);

            // Auto-save functionality
            useEffect(() => {
                if (lines.length === 0) return;

                // Clear existing timeout
                if (saveTimeoutRef.current) {
                    clearTimeout(saveTimeoutRef.current);
                }

                // Set new timeout for auto-save
                saveTimeoutRef.current = setTimeout(() => {
                    handleAutoSave();
                }, 2000); // Save 2 seconds after last change

                return () => {
                    if (saveTimeoutRef.current) {
                        clearTimeout(saveTimeoutRef.current);
                    }
                };
            }, [lines, waitlist, currentDate, currentShift]);

            const handleAutoSave = async () => {
                const staffingData = {
                    date: currentDate,
                    shift: currentShift,
                    lines: lines,
                    waitlist: waitlist,
                    locked: isLocked,
                    lastUpdated: new Date().toISOString()
                };

                // Always save to localStorage
                storage.save(`staffing_${currentDate}_${currentShift}`, staffingData);
                console.log('Saved to localStorage:', `staffing_${currentDate}_${currentShift}`);

                // Save to Firebase if configured
                if (isFirebaseConfigured && db) {
                    try {
                        const docId = `${currentDate}_${currentShift}`;
                        await db.ref('staffing/' + docId).set(staffingData);
                        console.log('Saved to Firebase Realtime Database:', docId);
                        setSaveStatus('Saved to cloud ✓');
                        setFirebaseStatus('connected');
                    } catch (error) {
                        console.error('Firebase save error:', error);
                        console.error('Error details:', error.code, error.message);
                        setFirebaseStatus('disconnected');
                        setSaveStatus('Error: ' + error.message);
                    }
                } else {
                    setSaveStatus('Saved locally');
                }

                // Clear status after 3 seconds
                setTimeout(() => setSaveStatus(''), 3000);
            };

            const loadStaffingData = async (date, shift) => {
                console.log('Loading staffing data for:', date, shift);

                // Try Firebase first
                if (isFirebaseConfigured && db) {
                    try {
                        const docId = `${date}_${shift}`;
                        const snapshot = await db.ref('staffing/' + docId).once('value');
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            console.log('Loaded from Firebase Realtime Database:', docId, data);
                            setLines(data.lines || []);
                            setWaitlist(data.waitlist || []);
                            setIsLocked(data.locked || false);
                            return;
                        } else {
                            console.log('Document not found in Firebase:', docId);
                        }
                    } catch (error) {
                        console.error('Firebase load error:', error);
                        alert('Error loading from Firebase: ' + error.message);
                    }
                }

                // Fallback to localStorage
                const localData = storage.load(`staffing_${date}_${shift}`, null);
                if (localData) {
                    console.log('Loaded from localStorage:', localData);
                    setLines(localData.lines || []);
                    setWaitlist(localData.waitlist || []);
                    setIsLocked(localData.locked || false);
                } else {
                    console.log('No data found');
                    setLines([]);
                    setWaitlist([]);
                    setIsLocked(false);
                }
            };

            const handleSetupShift = (shiftData) => {
                setCurrentDate(shiftData.date);
                setCurrentShift(shiftData.shift);

                // If loading existing sheet, just load the data
                if (shiftData.loadExisting) {
                    loadStaffingData(shiftData.date, shiftData.shift);
                    setActiveTab('staffing');
                    return;
                }

                const newLines = shiftData.lines.map(line => {
                    // Support both old (single lead) and new (multiple leads) format
                    const leads = line.leads || (line.lead ? [line.lead] : []);

                    // Combine core associates from all leads
                    const allCoreAssociates = [];
                    leads.forEach(lead => {
                        const coreList = coreAssociates[lead] || [];
                        allCoreAssociates.push(...coreList);
                    });

                    return {
                        id: Date.now() + Math.random(),
                        letter: line.letter,
                        leads: leads,
                        needed: parseInt(line.needed),
                        isCut: false,
                        positions: Array(parseInt(line.needed)).fill(null).map((_, idx) => {
                            // Pre-fill with core associates from all leads
                            if (idx < allCoreAssociates.length) {
                                return {
                                    id: Date.now() + Math.random() + idx,
                                    name: allCoreAssociates[idx].name,
                                    isNew: false
                                };
                            }
                            return {
                                id: Date.now() + Math.random() + idx,
                                name: '',
                                isNew: false
                            };
                        })
                    };
                });

                setLines(newLines);
                setWaitlist([]);
                setActiveTab('staffing');
            };

            const handleUpdatePosition = (lineId, positionId, name, isNew) => {
                setLines(prev => prev.map(line => {
                    if (line.id === lineId) {
                        return {
                            ...line,
                            positions: line.positions.map(pos =>
                                pos.id === positionId
                                    ? { ...pos, name: name, isNew }
                                    : pos
                            )
                        };
                    }
                    return line;
                }));
            };

            const handleUpdateWaitlistItem = (itemId, name, isNew) => {
                setWaitlist(prev => prev.map(item =>
                    item.id === itemId ? { ...item, name: name, isNew } : item
                ));
            };

            const handleAddWaitlistItem = () => {
                setWaitlist(prev => [...prev, {
                    id: Date.now() + Math.random(),
                    name: '',
                    isNew: false
                }]);
            };

            const handleQuickAddWaitlist = (names) => {
                const newItems = names.map(name => ({
                    id: Date.now() + Math.random(),
                    name: name,
                    isNew: false
                }));
                setWaitlist(prev => [...prev, ...newItems]);
            };

            const handleRemoveWaitlistItem = (itemId) => {
                setWaitlist(prev => prev.filter(item => item.id !== itemId));
            };

            const handleAddLine = () => {
                const newLine = {
                    id: Date.now() + Math.random(),
                    letter: '',
                    leads: [],
                    needed: 5,
                    isCut: false,
                    positions: Array(5).fill(null).map((_, idx) => ({
                        id: Date.now() + Math.random() + idx,
                        name: '',
                        isNew: false
                    }))
                };
                setLines(prev => [...prev, newLine]);
            };

            const handleToggleCutLine = (lineId) => {
                setLines(prev => prev.map(line => {
                    if (line.id === lineId) {
                        const newCutStatus = !line.isCut;

                        // If marking as cut, move all assigned associates to waitlist
                        if (newCutStatus) {
                            const assignedAssociates = line.positions
                                .filter(p => p.name.trim())
                                .map(p => ({
                                    id: Date.now() + Math.random(),
                                    name: p.name,
                                    isNew: p.isNew
                                }));

                            if (assignedAssociates.length > 0) {
                                setWaitlist(prev => [...prev, ...assignedAssociates]);
                            }

                            // Clear all positions
                            return {
                                ...line,
                                isCut: true,
                                positions: line.positions.map(p => ({ ...p, name: '', isNew: false }))
                            };
                        }

                        return { ...line, isCut: newCutStatus };
                    }
                    return line;
                }));
            };

            const handleDragStart = (e, source) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('application/json', JSON.stringify(source));

                // Create custom drag preview
                const dragPreview = document.createElement('div');
                dragPreview.className = 'drag-preview';

                // Get the name being dragged
                let dragName = '';
                if (source.type === 'waitlist') {
                    const item = waitlist.find(w => w.id === source.id);
                    dragName = item?.name || '';
                } else if (source.type === 'position') {
                    const line = lines.find(l => l.id === source.lineId);
                    const position = line?.positions.find(p => p.id === source.positionId);
                    dragName = position?.name || '';
                }

                dragPreview.innerHTML = `
                    <div style="min-width: 18px; font-size: 11px; font-weight: 600; color: #6b7280; text-align: center;">⋮⋮</div>
                    <div style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${dragName}</div>
                `;
                dragPreview.style.left = '-9999px';
                document.body.appendChild(dragPreview);
                e.dataTransfer.setDragImage(dragPreview, 0, 0);
                setTimeout(() => document.body.removeChild(dragPreview), 0);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, target) => {
                e.preventDefault();
                const source = JSON.parse(e.dataTransfer.getData('application/json'));

                // Don't allow drops on cut lines
                if (target.type === 'position') {
                    const targetLine = lines.find(l => l.id === target.lineId);
                    if (targetLine && targetLine.isCut) {
                        return;
                    }
                }

                // Handle different drop scenarios
                if (source.type === 'waitlist' && target.type === 'position') {
                    // Move from waitlist to position
                    const waitlistItem = waitlist.find(w => w.id === source.id);
                    const targetLine = lines.find(l => l.id === target.lineId);
                    const targetPosition = targetLine?.positions.find(p => p.id === target.positionId);

                    if (waitlistItem && targetPosition) {
                        // If target position is filled, move that person to waitlist first
                        if (targetPosition.name.trim()) {
                            setWaitlist(prev => [
                                ...prev.filter(w => w.id !== source.id),
                                {
                                    id: Date.now() + Math.random(),
                                    name: targetPosition.name,
                                    isNew: targetPosition.isNew
                                }
                            ]);
                        } else {
                            // Just remove from waitlist
                            handleRemoveWaitlistItem(source.id);
                        }
                        // Assign waitlist person to position
                        handleUpdatePosition(target.lineId, target.positionId, waitlistItem.name, waitlistItem.isNew);
                    }
                } else if (source.type === 'position' && target.type === 'waitlist') {
                    // Move from position to waitlist
                    const sourceLine = lines.find(l => l.id === source.lineId);
                    const sourcePosition = sourceLine?.positions.find(p => p.id === source.positionId);
                    if (sourcePosition && sourcePosition.name.trim()) {
                        setWaitlist(prev => [...prev, {
                            id: Date.now() + Math.random(),
                            name: sourcePosition.name,
                            isNew: sourcePosition.isNew
                        }]);
                        handleUpdatePosition(source.lineId, source.positionId, '', false);
                    }
                } else if (source.type === 'position' && target.type === 'position') {
                    // Swap positions - use a single state update to avoid race conditions
                    setLines(prev => prev.map(line => {
                        if (line.id === source.lineId || line.id === target.lineId) {
                            return {
                                ...line,
                                positions: line.positions.map(pos => {
                                    if (line.id === source.lineId && pos.id === source.positionId) {
                                        // Replace source with target
                                        const targetLine = prev.find(l => l.id === target.lineId);
                                        const targetPos = targetLine?.positions.find(p => p.id === target.positionId);
                                        return targetPos ? { ...pos, name: targetPos.name, isNew: targetPos.isNew } : pos;
                                    } else if (line.id === target.lineId && pos.id === target.positionId) {
                                        // Replace target with source
                                        const sourceLine = prev.find(l => l.id === source.lineId);
                                        const sourcePos = sourceLine?.positions.find(p => p.id === source.positionId);
                                        return sourcePos ? { ...pos, name: sourcePos.name, isNew: sourcePos.isNew } : pos;
                                    }
                                    return pos;
                                })
                            };
                        }
                        return line;
                    }));
                }
            };

            const handleRemoveLine = (lineId) => {
                if (confirm('Remove this line? This cannot be undone.')) {
                    setLines(prev => prev.filter(line => line.id !== lineId));
                }
            };

            const handleUpdateLine = (lineId, updates) => {
                setLines(prev => prev.map(line => {
                    if (line.id === lineId) {
                        const updatedLine = { ...line, ...updates };

                        // If needed count changed, adjust positions array
                        if (updates.needed !== undefined && updates.needed !== line.positions.length) {
                            const newNeeded = parseInt(updates.needed) || 0;
                            if (newNeeded > line.positions.length) {
                                // Add more positions
                                const additionalPositions = Array(newNeeded - line.positions.length)
                                    .fill(null)
                                    .map((_, idx) => ({
                                        id: Date.now() + Math.random() + idx,
                                        name: '',
                                        isNew: false
                                    }));
                                updatedLine.positions = [...line.positions, ...additionalPositions];
                            } else {
                                // Remove excess positions
                                updatedLine.positions = line.positions.slice(0, newNeeded);
                            }
                        }

                        return updatedLine;
                    }
                    return line;
                }));
            };

            const handleAddCoreAssociate = (lead, associate) => {
                setCoreAssociates(prev => ({
                    ...prev,
                    [lead]: [...(prev[lead] || []), associate]
                }));
            };

            const handleRemoveCoreAssociate = (lead, index) => {
                setCoreAssociates(prev => ({
                    ...prev,
                    [lead]: prev[lead].filter((_, i) => i !== index)
                }));
            };

            const handleUpdateCoreAssociate = (lead, index, updates) => {
                setCoreAssociates(prev => ({
                    ...prev,
                    [lead]: prev[lead].map((assoc, i) => i === index ? { ...assoc, ...updates } : assoc)
                }));
            };

            const handleDeleteLineLead = (lead) => {
                if (confirm(`Delete line lead "${lead}" and all associated core team members? This cannot be undone.`)) {
                    setCoreAssociates(prev => {
                        const updated = { ...prev };
                        delete updated[lead];
                        return updated;
                    });
                }
            };

            const handleExport = () => {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Calculate stats
                const activeLines = lines.filter(line => !line.isCut);
                const cutLines = lines.filter(line => line.isCut);
                const totalPositions = activeLines.reduce((sum, line) => sum + line.needed, 0);
                const filledPositions = activeLines.reduce((sum, line) =>
                    sum + line.positions.filter(p => p.name.trim()).length, 0
                );
                const newAssociates = activeLines.reduce((sum, line) =>
                    sum + line.positions.filter(p => p.name.trim() && p.isNew).length, 0
                );

                // Build data in column-based layout (like the tool)
                const data = [];

                // Title row
                data.push(['Crescent Staffing Planner']);

                // Info row
                data.push([`${currentDate} - ${currentShift} Shift`, '', '', '', `Exported: ${new Date().toLocaleString()}`]);

                // Stats row
                data.push([`${filledPositions} / ${totalPositions} filled`, `${newAssociates} new`, cutLines.length > 0 ? `${cutLines.length} cut` : '', waitlist.filter(w => w.name.trim()).length > 0 ? `${waitlist.filter(w => w.name.trim()).length} waiting` : '']);

                // Empty row
                data.push([]);

                // Find max positions needed for any line
                const maxPositions = Math.max(...lines.map(l => l.positions.length), waitlist.length);

                // Header row - Line letters and waitlist
                const headerRow = [];
                lines.forEach(line => {
                    headerRow.push(`Line ${line.letter}${line.isCut ? ' (CUT)' : ''}`);
                    headerRow.push(''); // Spacing column
                });
                headerRow.push('WAITLIST');
                data.push(headerRow);

                // Subheader row - Line leads
                const subheaderRow = [];
                lines.forEach(line => {
                    const leads = (line.leads || []).join(', ');
                    subheaderRow.push(leads || 'No lead');
                    subheaderRow.push(''); // Spacing column
                });
                subheaderRow.push('');
                data.push(subheaderRow);

                // Position rows
                for (let i = 0; i < maxPositions; i++) {
                    const row = [];
                    lines.forEach(line => {
                        const position = line.positions[i];
                        if (position) {
                            const name = position.name || '';
                            const marker = position.isNew ? ' ⭐' : '';
                            row.push(name + marker);
                        } else {
                            row.push('');
                        }
                        row.push(''); // Spacing column
                    });

                    // Add waitlist item
                    const waitlistItem = waitlist[i];
                    if (waitlistItem) {
                        const marker = waitlistItem.isNew ? ' ⭐' : '';
                        row.push((waitlistItem.name || '') + marker);
                    } else {
                        row.push('');
                    }

                    data.push(row);
                }

                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(data);

                // Set column widths
                const colWidths = [];
                lines.forEach(() => {
                    colWidths.push({ wch: 20 }); // Line column
                    colWidths.push({ wch: 2 });  // Spacing column
                });
                colWidths.push({ wch: 20 }); // Waitlist column
                ws['!cols'] = colWidths;

                // Apply styling
                const range = XLSX.utils.decode_range(ws['!ref']);

                // Style title (row 0)
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: C });
                    if (!ws[cellAddress]) continue;
                    ws[cellAddress].s = {
                        font: { bold: true, sz: 16, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "667EEA" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }

                // Style info row (row 1)
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 1, c: C });
                    if (!ws[cellAddress]) continue;
                    ws[cellAddress].s = {
                        font: { bold: true, sz: 11 },
                        fill: { fgColor: { rgb: "F3F4F6" } },
                        alignment: { horizontal: "center" }
                    };
                }

                // Style stats row (row 2)
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 2, c: C });
                    if (!ws[cellAddress]) continue;
                    ws[cellAddress].s = {
                        font: { sz: 10 },
                        fill: { fgColor: { rgb: "E5E7EB" } },
                        alignment: { horizontal: "center" }
                    };
                }

                // Style line headers (row 4)
                let colIndex = 0;
                lines.forEach((line, idx) => {
                    const cellAddress = XLSX.utils.encode_cell({ r: 4, c: colIndex });
                    if (ws[cellAddress]) {
                        ws[cellAddress].s = {
                            font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: line.isCut ? "EF4444" : "667EEA" } },
                            alignment: { horizontal: "center", vertical: "center" }
                        };
                    }
                    colIndex += 2; // Skip spacing column
                });

                // Style waitlist header
                const waitlistHeaderCell = XLSX.utils.encode_cell({ r: 4, c: colIndex });
                if (ws[waitlistHeaderCell]) {
                    ws[waitlistHeaderCell].s = {
                        font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "F59E0B" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }

                // Style lead names (row 5)
                colIndex = 0;
                lines.forEach(() => {
                    const cellAddress = XLSX.utils.encode_cell({ r: 5, c: colIndex });
                    if (ws[cellAddress]) {
                        ws[cellAddress].s = {
                            font: { italic: true, sz: 10 },
                            fill: { fgColor: { rgb: "F9FAFB" } },
                            alignment: { horizontal: "center" }
                        };
                    }
                    colIndex += 2;
                });

                // Style position cells (starting from row 6)
                for (let R = 6; R <= range.e.r; R++) {
                    colIndex = 0;
                    lines.forEach((line) => {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: colIndex });
                        if (ws[cellAddress]) {
                            const cellValue = ws[cellAddress].v || '';
                            const isNew = cellValue.includes('⭐');
                            const isEmpty = !cellValue.trim() || cellValue.trim() === '⭐';

                            ws[cellAddress].s = {
                                fill: {
                                    fgColor: {
                                        rgb: isEmpty ? "FFFFFF" :
                                             isNew ? "DBEAFE" :
                                             line.isCut ? "FEE2E2" :
                                             "F0FDF4"
                                    }
                                },
                                border: {
                                    top: { style: "thin", color: { rgb: "E5E7EB" } },
                                    bottom: { style: "thin", color: { rgb: "E5E7EB" } },
                                    left: { style: "thin", color: { rgb: "E5E7EB" } },
                                    right: { style: "thin", color: { rgb: "E5E7EB" } }
                                },
                                alignment: { vertical: "center" }
                            };
                        }
                        colIndex += 2;
                    });

                    // Style waitlist cells
                    const waitlistCell = XLSX.utils.encode_cell({ r: R, c: colIndex });
                    if (ws[waitlistCell]) {
                        const cellValue = ws[waitlistCell].v || '';
                        const isNew = cellValue.includes('⭐');
                        const isEmpty = !cellValue.trim() || cellValue.trim() === '⭐';

                        ws[waitlistCell].s = {
                            fill: {
                                fgColor: {
                                    rgb: isEmpty ? "FFFFFF" :
                                         isNew ? "DBEAFE" :
                                         "FEF3C7"
                                }
                            },
                            border: {
                                top: { style: "thin", color: { rgb: "E5E7EB" } },
                                bottom: { style: "thin", color: { rgb: "E5E7EB" } },
                                left: { style: "thin", color: { rgb: "E5E7EB" } },
                                right: { style: "thin", color: { rgb: "E5E7EB" } }
                            },
                            alignment: { vertical: "center" }
                        };
                    }
                }

                XLSX.utils.book_append_sheet(wb, ws, 'Staffing');

                // Export file
                XLSX.writeFile(wb, `staffing-${currentDate}-${currentShift}.xlsx`);
            };

            const handleClearAll = () => {
                if (confirm('Clear current shift data? This cannot be undone.')) {
                    setLines([]);
                    setWaitlist([]);
                }
            };

            const handleToggleLock = () => {
                if (!isLocked) {
                    // Locking
                    if (confirm('Lock this staffing sheet? Once locked, no edits can be made until it is unlocked.')) {
                        setIsLocked(true);
                    }
                } else {
                    // Unlocking
                    if (confirm('Unlock this staffing sheet? This will allow edits to be made.')) {
                        setIsLocked(false);
                    }
                }
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>Crescent Staffing Planner</h1>
                        <div className="header-actions">
                            {lines.length > 0 && (
                                <>
                                    <button className="btn btn-secondary" onClick={handleExport}>
                                        Export
                                    </button>
                                    <button className="btn btn-danger" onClick={handleClearAll}>
                                        Clear
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    <div className="content">
                        <div className="tabs">
                            <button
                                className={`tab ${activeTab === 'setup' ? 'active' : ''}`}
                                onClick={() => setActiveTab('setup')}
                            >
                                Setup
                            </button>
                            <button
                                className={`tab ${activeTab === 'staffing' ? 'active' : ''}`}
                                onClick={() => setActiveTab('staffing')}
                            >
                                Staffing
                            </button>
                            <button
                                className={`tab ${activeTab === 'reporting' ? 'active' : ''}`}
                                onClick={() => setActiveTab('reporting')}
                            >
                                Reports
                            </button>
                            <button
                                className={`tab ${activeTab === 'core' ? 'active' : ''}`}
                                onClick={() => setActiveTab('core')}
                            >
                                Core Team
                            </button>
                        </div>

                        {activeTab === 'setup' && (
                            <SetupView
                                onSetupShift={handleSetupShift}
                                coreAssociates={coreAssociates}
                                initialDate={currentDate}
                                initialShift={currentShift}
                            />
                        )}

                        {activeTab === 'staffing' && (
                            <StaffingView
                                lines={lines}
                                waitlist={waitlist}
                                currentDate={currentDate}
                                currentShift={currentShift}
                                saveStatus={saveStatus}
                                isLocked={isLocked}
                                onToggleLock={handleToggleLock}
                                onUpdatePosition={handleUpdatePosition}
                                onUpdateWaitlistItem={handleUpdateWaitlistItem}
                                onAddWaitlistItem={handleAddWaitlistItem}
                                onQuickAddWaitlist={handleQuickAddWaitlist}
                                onRemoveWaitlistItem={handleRemoveWaitlistItem}
                                onAddLine={handleAddLine}
                                onRemoveLine={handleRemoveLine}
                                onUpdateLine={handleUpdateLine}
                                onToggleCutLine={handleToggleCutLine}
                                onDragStart={handleDragStart}
                                onDragOver={handleDragOver}
                                onDrop={handleDrop}
                            />
                        )}

                        {activeTab === 'reporting' && (
                            <ReportingView
                                onLoadShift={(date, shift) => {
                                    setCurrentDate(date);
                                    setCurrentShift(shift);
                                    loadStaffingData(date, shift);
                                    setActiveTab('staffing');
                                }}
                            />
                        )}

                        {activeTab === 'core' && (
                            <CoreAssociatesView
                                coreAssociates={coreAssociates}
                                onAddCoreAssociate={handleAddCoreAssociate}
                                onRemoveCoreAssociate={handleRemoveCoreAssociate}
                                onUpdateCoreAssociate={handleUpdateCoreAssociate}
                                onDeleteLineLead={handleDeleteLineLead}
                                firebaseStatus={firebaseStatus}
                            />
                        )}
                    </div>
                </div>
            );
        }

        function StaffingView({
            lines,
            waitlist,
            currentDate,
            currentShift,
            saveStatus,
            isLocked,
            onToggleLock,
            onUpdatePosition,
            onUpdateWaitlistItem,
            onAddWaitlistItem,
            onQuickAddWaitlist,
            onRemoveWaitlistItem,
            onAddLine,
            onRemoveLine,
            onUpdateLine,
            onToggleCutLine,
            onDragStart,
            onDragOver,
            onDrop
        }) {
            const [isQuickAddOpen, setIsQuickAddOpen] = useState(false);
            const [quickAddInput, setQuickAddInput] = useState('');
            const [quickAddNames, setQuickAddNames] = useState([]);
            const quickAddInputRef = useRef(null);

            useEffect(() => {
                if (isQuickAddOpen && quickAddInputRef.current) {
                    quickAddInputRef.current.focus();
                }
            }, [isQuickAddOpen]);

            const handleQuickAddKeyPress = (e) => {
                if (e.key === 'Enter' && quickAddInput.trim()) {
                    setQuickAddNames([...quickAddNames, quickAddInput.trim()]);
                    setQuickAddInput('');
                } else if (e.key === 'Escape') {
                    handleCancelQuickAdd();
                }
            };

            const handleRemoveQuickAddName = (index) => {
                setQuickAddNames(quickAddNames.filter((_, i) => i !== index));
            };

            const handleConfirmQuickAdd = () => {
                if (quickAddNames.length > 0) {
                    onQuickAddWaitlist(quickAddNames);
                }
                setIsQuickAddOpen(false);
                setQuickAddInput('');
                setQuickAddNames([]);
            };

            const handleCancelQuickAdd = () => {
                setIsQuickAddOpen(false);
                setQuickAddInput('');
                setQuickAddNames([]);
            };

            if (lines.length === 0) {
                return (
                    <div className="empty-state">
                        <h3>No Shift Configured</h3>
                        <p>Go to "Setup" to create today's staffing chart.</p>
                    </div>
                );
            }

            // Calculate stats excluding cut lines
            const activeLines = lines.filter(line => !line.isCut);
            const cutLines = lines.filter(line => line.isCut);
            const totalPositions = activeLines.reduce((sum, line) => sum + line.needed, 0);
            const filledPositions = activeLines.reduce((sum, line) =>
                sum + line.positions.filter(p => p.name.trim()).length, 0
            );
            const newAssociates = activeLines.reduce((sum, line) =>
                sum + line.positions.filter(p => p.name.trim() && p.isNew).length, 0
            );

            return (
                <>
                    {!isFirebaseConfigured && (
                        <div className="firebase-config">
                            <h4>⚠️ Firebase Not Configured</h4>
                            <p>Data is being saved locally only. To enable cloud sync and remote access, please configure Firebase in the code.</p>
                        </div>
                    )}

                    <div className="stats-bar">
                        <div>
                            <strong>{currentDate}</strong> - {currentShift} Shift
                            {isLocked && (
                                <span style={{ marginLeft: '12px', padding: '4px 8px', background: '#fee2e2', color: '#991b1b', borderRadius: '4px', fontSize: '11px', fontWeight: '600' }}>
                                    🔒 LOCKED
                                </span>
                            )}
                        </div>
                        <div>
                            <strong style={{ color: '#10b981', fontSize: '14px' }}>{filledPositions}</strong> / {totalPositions} filled
                            {newAssociates > 0 && <span style={{ marginLeft: '12px', color: '#3b82f6' }}>• {newAssociates} new</span>}
                            {cutLines.length > 0 && <span style={{ marginLeft: '12px', color: '#ef4444' }}>• {cutLines.length} cut</span>}
                            {waitlist.filter(w => w.name.trim()).length > 0 && <span style={{ marginLeft: '12px', color: '#f59e0b' }}>• {waitlist.filter(w => w.name.trim()).length} waiting</span>}
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <button
                                className={`btn ${isLocked ? 'btn-danger' : 'btn-secondary'}`}
                                onClick={onToggleLock}
                                style={{ fontSize: '12px', padding: '6px 12px' }}
                            >
                                {isLocked ? '🔓 Unlock' : '🔒 Lock'}
                            </button>
                            {saveStatus && (
                                <div className="save-status">{saveStatus}</div>
                            )}
                        </div>
                    </div>

                    <div className="staffing-layout">
                        <div className="lines-container">
                            {lines.map(line => (
                                <LineColumn
                                    key={line.id}
                                    line={line}
                                    isLocked={isLocked}
                                    onUpdatePosition={onUpdatePosition}
                                    onUpdateLine={onUpdateLine}
                                    onRemoveLine={onRemoveLine}
                                    onToggleCutLine={onToggleCutLine}
                                    onDragStart={onDragStart}
                                    onDragOver={onDragOver}
                                    onDrop={onDrop}
                                />
                            ))}
                            <div className="line-column" style={{ minWidth: '120px', width: '120px', justifyContent: 'center', alignItems: 'center', cursor: isLocked ? 'not-allowed' : 'pointer', background: '#f9fafb', opacity: isLocked ? 0.5 : 1 }} onClick={isLocked ? null : onAddLine}>
                                <div style={{ textAlign: 'center', color: '#667eea', fontSize: '14px', fontWeight: '600' }}>
                                    <div style={{ fontSize: '32px', marginBottom: '8px' }}>+</div>
                                    <div>Add Line</div>
                                </div>
                            </div>
                        </div>

                        <div
                            className="waitlist-sidebar"
                            onDragOver={isLocked ? null : onDragOver}
                            onDrop={(e) => isLocked ? e.preventDefault() : onDrop(e, { type: 'waitlist' })}
                        >
                            <div className="waitlist-header">
                                WAITLIST ({waitlist.filter(w => w.name.trim()).length})
                                <div style={{ display: 'flex', gap: '4px', marginLeft: '8px' }}>
                                    <button
                                        className="btn btn-primary btn-small"
                                        onClick={() => setIsQuickAddOpen(true)}
                                        disabled={isLocked}
                                        style={{ fontSize: '11px', opacity: isLocked ? 0.5 : 1 }}
                                    >
                                        Quick Add
                                    </button>
                                    <button
                                        className="btn btn-success btn-small"
                                        onClick={onAddWaitlistItem}
                                        disabled={isLocked}
                                        style={{ opacity: isLocked ? 0.5 : 1 }}
                                    >
                                        + Add
                                    </button>
                                </div>
                            </div>
                            <div className="waitlist-items">
                                {waitlist.map((item, idx) => (
                                    <div
                                        key={item.id}
                                        className="waitlist-item"
                                        draggable={!isLocked && item.name.trim() !== ''}
                                        onDragStart={(e) => isLocked ? e.preventDefault() : onDragStart(e, { type: 'waitlist', id: item.id })}
                                        style={{ cursor: isLocked ? 'not-allowed' : (item.name.trim() ? 'grab' : 'default'), opacity: isLocked ? 0.7 : 1 }}
                                    >
                                        <div style={{ fontSize: '10px', color: '#6b7280', fontWeight: '600' }}>
                                            #{idx + 1}
                                        </div>
                                        <input
                                            type="text"
                                            className="waitlist-input"
                                            value={item.name}
                                            onChange={(e) => onUpdateWaitlistItem(item.id, e.target.value, item.isNew)}
                                            placeholder="Type name..."
                                            disabled={isLocked}
                                        />
                                        <div className="waitlist-controls">
                                            <input
                                                type="checkbox"
                                                checked={item.isNew}
                                                onChange={(e) => onUpdateWaitlistItem(item.id, item.name, e.target.checked)}
                                                style={{ width: '14px', height: '14px' }}
                                                disabled={isLocked}
                                            />
                                            <label style={{ fontSize: '11px', flex: 1 }}>New</label>
                                            <button
                                                className="btn btn-danger btn-small"
                                                onClick={() => onRemoveWaitlistItem(item.id)}
                                                disabled={isLocked}
                                                style={{ opacity: isLocked ? 0.5 : 1 }}
                                            >
                                                ×
                                            </button>
                                        </div>
                                    </div>
                                ))}
                                {waitlist.length === 0 && (
                                    <div style={{ textAlign: 'center', padding: '20px', color: '#6b7280', fontSize: '12px' }}>
                                        No one waiting
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Quick Add Modal */}
                    {isQuickAddOpen && (
                        <div className="quick-add-modal" onClick={handleCancelQuickAdd}>
                            <div className="quick-add-content" onClick={(e) => e.stopPropagation()}>
                                <div className="quick-add-header">
                                    <h3 className="quick-add-title">Quick Add to Waitlist</h3>
                                    <button
                                        className="btn btn-secondary btn-small"
                                        onClick={handleCancelQuickAdd}
                                    >
                                        ×
                                    </button>
                                </div>

                                <input
                                    ref={quickAddInputRef}
                                    type="text"
                                    className="quick-add-input"
                                    value={quickAddInput}
                                    onChange={(e) => setQuickAddInput(e.target.value)}
                                    onKeyDown={handleQuickAddKeyPress}
                                    placeholder="Type a name and press Enter..."
                                />

                                <div className="quick-add-hint">
                                    Press Enter to add • Press Escape to close
                                </div>

                                {quickAddNames.length > 0 && (
                                    <div className="quick-add-list">
                                        {quickAddNames.map((name, index) => (
                                            <div key={index} className="quick-add-item">
                                                <span style={{ fontWeight: '500' }}>
                                                    {index + 1}. {name}
                                                </span>
                                                <button
                                                    className="btn btn-danger btn-small"
                                                    onClick={() => handleRemoveQuickAddName(index)}
                                                >
                                                    ×
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {quickAddNames.length === 0 && (
                                    <div style={{ textAlign: 'center', padding: '20px', color: '#9ca3af', fontSize: '13px', fontStyle: 'italic' }}>
                                        No names added yet
                                    </div>
                                )}

                                <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
                                    <button
                                        className="btn btn-secondary"
                                        onClick={handleCancelQuickAdd}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        className="btn btn-success"
                                        onClick={handleConfirmQuickAdd}
                                        disabled={quickAddNames.length === 0}
                                    >
                                        Add {quickAddNames.length} to Waitlist
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        }

        function LineColumn({ line, isLocked, onUpdatePosition, onUpdateLine, onRemoveLine, onToggleCutLine, onDragStart, onDragOver, onDrop }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editLetter, setEditLetter] = useState(line.letter);
            const [editLeads, setEditLeads] = useState((line.leads || []).join(', '));
            const [editNeeded, setEditNeeded] = useState(line.needed);

            const filledCount = line.positions.filter(p => p.name.trim()).length;
            const leads = line.leads || (line.lead ? [line.lead] : []);

            const handleSaveEdit = () => {
                const leadsArray = editLeads.split(',').map(l => l.trim()).filter(l => l);
                onUpdateLine(line.id, {
                    letter: editLetter,
                    leads: leadsArray,
                    needed: parseInt(editNeeded) || line.needed
                });
                setIsEditing(false);
            };

            const handleCancelEdit = () => {
                setEditLetter(line.letter);
                setEditLeads((line.leads || []).join(', '));
                setEditNeeded(line.needed);
                setIsEditing(false);
            };

            return (
                <div className={`line-column ${line.isCut ? 'cut' : ''}`} style={{ position: 'relative' }}>
                    {line.isCut && <div className="cut-badge">CUT</div>}
                    <div className="line-header">
                        {!isEditing ? (
                            <>
                                <div className="line-letter">Line {line.letter || '?'}</div>
                                <div className="line-lead">
                                    {leads.length > 0 ? leads.join(', ') : 'No lead'}
                                </div>
                                <div className="line-stats">{filledCount} / {line.needed} filled</div>
                                <div className="line-edit-controls">
                                    <button
                                        className="btn btn-secondary btn-small"
                                        onClick={() => onToggleCutLine(line.id)}
                                        disabled={isLocked}
                                        style={{ fontSize: '10px', padding: '3px 6px', background: line.isCut ? '#10b981' : '#ef4444', color: 'white', border: 'none', opacity: isLocked ? 0.5 : 1 }}
                                    >
                                        {line.isCut ? 'Restore' : 'Cut'}
                                    </button>
                                    <button
                                        className="btn btn-secondary btn-small"
                                        onClick={() => setIsEditing(true)}
                                        disabled={isLocked}
                                        style={{ fontSize: '10px', padding: '3px 6px', opacity: isLocked ? 0.5 : 1 }}
                                    >
                                        Edit
                                    </button>
                                    <button
                                        className="btn btn-danger btn-small"
                                        onClick={() => onRemoveLine(line.id)}
                                        disabled={isLocked}
                                        style={{ fontSize: '10px', padding: '3px 6px', opacity: isLocked ? 0.5 : 1 }}
                                    >
                                        Remove
                                    </button>
                                </div>
                            </>
                        ) : (
                            <>
                                <div style={{ fontSize: '10px', marginBottom: '4px', opacity: 0.9 }}>Edit Line</div>
                                <input
                                    type="text"
                                    className="line-edit-input"
                                    value={editLetter}
                                    onChange={(e) => setEditLetter(e.target.value.toUpperCase())}
                                    placeholder="Letter (A, B, C...)"
                                    maxLength="2"
                                />
                                <input
                                    type="text"
                                    className="line-edit-input"
                                    value={editLeads}
                                    onChange={(e) => setEditLeads(e.target.value)}
                                    placeholder="Leads (comma-separated)"
                                />
                                <input
                                    type="number"
                                    className="line-edit-input"
                                    value={editNeeded}
                                    onChange={(e) => setEditNeeded(e.target.value)}
                                    placeholder="Quantity"
                                    min="1"
                                />
                                <div className="line-edit-controls">
                                    <button
                                        className="btn btn-success btn-small"
                                        onClick={handleSaveEdit}
                                        style={{ fontSize: '10px', padding: '3px 6px' }}
                                    >
                                        Save
                                    </button>
                                    <button
                                        className="btn btn-secondary btn-small"
                                        onClick={handleCancelEdit}
                                        style={{ fontSize: '10px', padding: '3px 6px' }}
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                    <div className="positions-list">
                        {line.positions.map((position, index) => (
                            <div
                                key={position.id}
                                className={`position-slot ${position.name.trim() ? 'filled' : ''} ${position.isNew ? 'new-associate' : ''}`}
                                draggable={!isLocked && position.name.trim() !== '' && !line.isCut}
                                onDragStart={(e) => isLocked ? e.preventDefault() : onDragStart(e, { type: 'position', lineId: line.id, positionId: position.id })}
                                onDragOver={onDragOver}
                                onDrop={(e) => isLocked ? e.preventDefault() : onDrop(e, { type: 'position', lineId: line.id, positionId: position.id })}
                                style={{ cursor: isLocked ? 'not-allowed' : (position.name.trim() && !line.isCut ? 'grab' : 'default'), opacity: isLocked ? 0.7 : 1 }}
                            >
                                <div className="position-number">{index + 1}</div>
                                <input
                                    type="text"
                                    className="position-input"
                                    value={position.name}
                                    onChange={(e) => onUpdatePosition(line.id, position.id, e.target.value, position.isNew)}
                                    placeholder="Name..."
                                    disabled={line.isCut || isLocked}
                                />
                                <div className="position-checkbox">
                                    <input
                                        type="checkbox"
                                        checked={position.isNew}
                                        onChange={(e) => onUpdatePosition(line.id, position.id, position.name, e.target.checked)}
                                        disabled={line.isCut || isLocked}
                                    />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function SetupView({ onSetupShift, coreAssociates, initialDate, initialShift }) {
            const [date, setDate] = useState(initialDate);
            const [shift, setShift] = useState(initialShift);
            const [lines, setLines] = useState([{ letter: '', lead: '', needed: '' }]);

            const handleAddLine = () => {
                setLines([...lines, { letter: '', lead: '', needed: '' }]);
            };

            const handleRemoveLine = (index) => {
                setLines(lines.filter((_, i) => i !== index));
            };

            const handleLineChange = (index, field, value) => {
                const newLines = [...lines];
                newLines[index][field] = value;
                setLines(newLines);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();

                // Check if staffing sheet already exists for this date/shift
                const docId = `${date}_${shift}`;
                let existsInFirebase = false;
                let existsInLocalStorage = false;

                // Check Firebase
                if (isFirebaseConfigured && db) {
                    try {
                        const snapshot = await db.ref('staffing/' + docId).once('value');
                        existsInFirebase = snapshot.exists();
                    } catch (error) {
                        console.error('Error checking Firebase:', error);
                    }
                }

                // Check localStorage
                const localData = storage.load(`staffing_${date}_${shift}`, null);
                existsInLocalStorage = localData !== null;

                // If exists, prevent creating a new one
                if (existsInFirebase || existsInLocalStorage) {
                    const location = existsInFirebase ? 'cloud' : 'local storage';
                    const confirmed = confirm(
                        `A staffing sheet already exists for ${date} - ${shift} Shift (saved in ${location}).\n\n` +
                        `Only one staffing sheet can exist per date and shift to prevent data conflicts.\n\n` +
                        `Would you like to load the existing sheet instead?`
                    );

                    if (confirmed) {
                        // Load the existing sheet instead
                        onSetupShift({ date, shift, loadExisting: true });
                    }
                    return; // Don't create a new sheet
                }

                const validLines = lines.filter(l => l.letter && l.lead && l.needed).map(l => ({
                    ...l,
                    leads: l.lead.split(',').map(lead => lead.trim()).filter(lead => lead)
                }));
                if (validLines.length > 0) {
                    onSetupShift({ date, shift, lines: validLines });
                } else {
                    alert('Please fill in all fields for at least one line.');
                }
            };

            const allLeads = Object.keys(coreAssociates);

            return (
                <form onSubmit={handleSubmit} className="setup-form">
                    <div className="form-section">
                        <h3>Shift Information</h3>
                        <div className="form-grid">
                            <div className="form-group">
                                <label>Date *</label>
                                <input
                                    type="date"
                                    value={date}
                                    onChange={(e) => setDate(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>Shift *</label>
                                <select value={shift} onChange={(e) => setShift(e.target.value)} required>
                                    <option>1st</option>
                                    <option>2nd</option>
                                    <option>Swing</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div className="form-section">
                        <h3>Configure Production Lines</h3>
                        {lines.map((line, index) => (
                            <div key={index} className="form-grid" style={{ marginBottom: '12px', padding: '12px', background: 'white', borderRadius: '6px' }}>
                                <div className="form-group">
                                    <label>Line Letter *</label>
                                    <input
                                        type="text"
                                        value={line.letter}
                                        onChange={(e) => handleLineChange(index, 'letter', e.target.value.toUpperCase())}
                                        placeholder="A, B, C..."
                                        required
                                        maxLength="2"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Line Lead(s) * <span style={{ fontSize: '10px', fontWeight: 'normal', opacity: '0.7' }}>(comma-separated for multiple)</span></label>
                                    <input
                                        type="text"
                                        list="leads"
                                        value={line.lead}
                                        onChange={(e) => handleLineChange(index, 'lead', e.target.value)}
                                        placeholder="John Doe, Jane Smith"
                                        required
                                    />
                                    <datalist id="leads">
                                        {allLeads.map(lead => (
                                            <option key={lead} value={lead} />
                                        ))}
                                    </datalist>
                                </div>
                                <div className="form-group">
                                    <label>Associates Needed *</label>
                                    <input
                                        type="number"
                                        value={line.needed}
                                        onChange={(e) => handleLineChange(index, 'needed', e.target.value)}
                                        placeholder="Number"
                                        required
                                        min="1"
                                        max="50"
                                    />
                                </div>
                                {lines.length > 1 && (
                                    <div style={{ display: 'flex', alignItems: 'flex-end' }}>
                                        <button
                                            type="button"
                                            className="btn btn-danger btn-small"
                                            onClick={() => handleRemoveLine(index)}
                                        >
                                            Remove
                                        </button>
                                    </div>
                                )}
                            </div>
                        ))}
                        <button type="button" className="btn btn-success" onClick={handleAddLine} style={{ marginTop: '12px' }}>
                            + Add Another Line
                        </button>
                    </div>

                    <button type="submit" className="btn btn-success" style={{ fontSize: '14px', padding: '10px 20px' }}>
                        Start Staffing
                    </button>
                </form>
            );
        }

        function ReportingView({ onLoadShift }) {
            const [reports, setReports] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                loadReports();
            }, []);

            const loadReports = async () => {
                setLoading(true);
                const reportsList = [];
                const firebaseReportIds = new Set();

                // Load from Firebase if configured
                if (isFirebaseConfigured && db) {
                    try {
                        const snapshot = await db.ref('staffing').once('value');
                        if (snapshot.exists()) {
                            const staffingData = snapshot.val();
                            Object.keys(staffingData).forEach(docId => {
                                const data = staffingData[docId];
                                reportsList.push({ id: docId, ...data, syncedToCloud: true });
                                firebaseReportIds.add(docId);
                            });
                        }
                        console.log('Loaded from Firebase Realtime Database:', reportsList.length, 'reports');
                    } catch (error) {
                        console.error('Error loading Firebase reports:', error);
                        alert('Error loading from Firebase: ' + error.message);
                    }
                }

                // Also check localStorage
                const localKeys = Object.keys(localStorage)
                    .filter(key => key.startsWith('staffing_'))
                    .filter(key => !key.includes('coreAssociates'));

                localKeys.forEach(key => {
                    const data = storage.load(key);
                    const reportId = `${data.date}_${data.shift}`;
                    if (data && !reportsList.find(r => r.id === reportId)) {
                        // This report is only in localStorage, not synced to cloud
                        reportsList.push({ id: reportId, ...data, syncedToCloud: false });
                    }
                });

                // Sort by date and shift (client-side)
                reportsList.sort((a, b) => {
                    if (a.date !== b.date) return b.date.localeCompare(a.date);
                    return a.shift.localeCompare(b.shift);
                });

                console.log('Total reports loaded:', reportsList.length);
                setReports(reportsList);
                setLoading(false);
            };

            return (
                <div>
                    <div className="report-controls">
                        <h3 style={{ marginBottom: '8px' }}>Saved Staffing Reports</h3>
                        <p style={{ fontSize: '12px', color: '#6b7280' }}>
                            View and load previous staffing sheets
                        </p>
                    </div>

                    {loading ? (
                        <div className="empty-state">
                            <p>Loading reports...</p>
                        </div>
                    ) : reports.length === 0 ? (
                        <div className="empty-state">
                            <h3>No Reports Available</h3>
                            <p>Staffing sheets will appear here after you save them.</p>
                        </div>
                    ) : (
                        <div className="report-list">
                            {reports.map(report => {
                                const totalPositions = report.lines.reduce((sum, line) => sum + line.needed, 0);
                                const filledPositions = report.lines.reduce((sum, line) =>
                                    sum + line.positions.filter(p => p.name && p.name.trim()).length, 0
                                );

                                return (
                                    <div
                                        key={report.id}
                                        className="report-item"
                                        onClick={() => onLoadShift(report.date, report.shift)}
                                    >
                                        <h4>
                                            {report.date} - {report.shift} Shift
                                            {report.syncedToCloud ? (
                                                <span className="cloud-badge synced">☁ Synced</span>
                                            ) : (
                                                <span className="cloud-badge local-only">📱 Local Only</span>
                                            )}
                                        </h4>
                                        <p>
                                            {filledPositions} / {totalPositions} positions filled
                                            {report.waitlist && report.waitlist.length > 0 && ` • ${report.waitlist.filter(w => w.name && w.name.trim()).length} waiting`}
                                        </p>
                                        {report.lastUpdated && (
                                            <p style={{ fontSize: '11px', marginTop: '4px' }}>
                                                Last updated: {new Date(report.lastUpdated).toLocaleString()}
                                            </p>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        const AVAILABLE_FLAGS = [
            { id: 'sitdown', label: 'Sit-Down', className: 'flag-sitdown' },
            { id: 'sanitation', label: 'Sanitation', className: 'flag-sanitation' },
            { id: 'office', label: 'Office Support', className: 'flag-office' },
            { id: 'high', label: 'High Performer', className: 'flag-high' },
            { id: 'low', label: 'Low Performer', className: 'flag-low' }
        ];

        function FlagsDropdown({ flags = [], onChange, inForm = false }) {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };

                if (isOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }

                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [isOpen]);

            const toggleFlag = (flagId) => {
                const newFlags = flags.includes(flagId)
                    ? flags.filter(f => f !== flagId)
                    : [...flags, flagId];
                onChange(newFlags);
            };

            const selectedFlagsText = flags.length > 0
                ? flags.map(fid => AVAILABLE_FLAGS.find(f => f.id === fid)?.label).filter(Boolean).join(', ')
                : 'Click to select flags...';

            return (
                <div className="flag-dropdown" ref={dropdownRef}>
                    {inForm ? (
                        <button
                            type="button"
                            className="flag-dropdown-button"
                            onClick={() => setIsOpen(!isOpen)}
                        >
                            <span style={{ color: flags.length === 0 ? '#9ca3af' : '#111827' }}>
                                {selectedFlagsText}
                            </span>
                            <span style={{ fontSize: '10px', color: '#6b7280' }}>
                                {isOpen ? '▲' : '▼'}
                            </span>
                        </button>
                    ) : (
                        <button
                            type="button"
                            className="btn btn-secondary btn-small"
                            onClick={() => setIsOpen(!isOpen)}
                            style={{ fontSize: '11px' }}
                        >
                            Edit Flags ({flags.length})
                        </button>
                    )}
                    {isOpen && (
                        <div className="flag-dropdown-content">
                            <div style={{ fontSize: '11px', fontWeight: '600', color: '#6b7280', marginBottom: '8px', paddingBottom: '6px', borderBottom: '1px solid #e5e7eb' }}>
                                Select Flags:
                            </div>
                            {AVAILABLE_FLAGS.map(flag => (
                                <div key={flag.id} className="flag-option">
                                    <input
                                        type="checkbox"
                                        checked={flags.includes(flag.id)}
                                        onChange={() => toggleFlag(flag.id)}
                                        id={`flag-${flag.id}-${Math.random()}`}
                                    />
                                    <label
                                        style={{ cursor: 'pointer', flex: 1 }}
                                        onClick={() => toggleFlag(flag.id)}
                                    >
                                        {flag.label}
                                    </label>
                                </div>
                            ))}
                            {flags.length === 0 && (
                                <div style={{ fontSize: '11px', color: '#9ca3af', padding: '8px', textAlign: 'center', fontStyle: 'italic' }}>
                                    No flags selected
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function CoreAssociatesView({ coreAssociates, onAddCoreAssociate, onRemoveCoreAssociate, onUpdateCoreAssociate, onDeleteLineLead, firebaseStatus }) {
            const [viewMode, setViewMode] = useState('byLead'); // 'byLead' or 'all'
            const [selectedLead, setSelectedLead] = useState('');
            const [newLead, setNewLead] = useState('');
            const [newName, setNewName] = useState('');
            const [newFlags, setNewFlags] = useState([]);
            const [filterFlags, setFilterFlags] = useState([]);
            const [sortBy, setSortBy] = useState('name'); // 'name' or flag id
            const [searchQuery, setSearchQuery] = useState('');

            const allLeads = Object.keys(coreAssociates);

            // Get all associates across all leads for "All" view
            const getAllAssociates = () => {
                const all = [];
                Object.entries(coreAssociates).forEach(([lead, associates]) => {
                    associates.forEach((assoc, index) => {
                        all.push({
                            ...assoc,
                            lead: lead,
                            leadIndex: index,
                            flags: assoc.flags || []
                        });
                    });
                });
                return all;
            };

            const getFilteredAssociates = () => {
                let associates = viewMode === 'all' ? getAllAssociates() : (coreAssociates[selectedLead || newLead] || []).map(a => ({ ...a, flags: a.flags || [] }));

                // Apply search filter
                if (searchQuery.trim()) {
                    associates = associates.filter(assoc =>
                        assoc.name.toLowerCase().includes(searchQuery.toLowerCase())
                    );
                }

                // Apply flag filters
                if (filterFlags.length > 0) {
                    associates = associates.filter(assoc =>
                        filterFlags.every(flag => (assoc.flags || []).includes(flag))
                    );
                }

                // Sort
                return [...associates].sort((a, b) => {
                    if (sortBy === 'name') {
                        return a.name.localeCompare(b.name);
                    } else {
                        const aHasFlag = (a.flags || []).includes(sortBy) ? 1 : 0;
                        const bHasFlag = (b.flags || []).includes(sortBy) ? 1 : 0;
                        return bHasFlag - aHasFlag;
                    }
                });
            };

            const handleAddAssociate = (e) => {
                e.preventDefault();
                const currentLead = selectedLead || newLead;
                if (currentLead && newName) {
                    onAddCoreAssociate(currentLead, {
                        name: newName,
                        flags: newFlags
                    });
                    setNewName('');
                    setNewFlags([]);
                    if (newLead) {
                        setSelectedLead(newLead);
                        setNewLead('');
                    }
                }
            };

            const handleUpdateAssociateFlags = (lead, index, newFlags) => {
                onUpdateCoreAssociate(lead, index, { flags: newFlags });
            };

            const filteredAssociates = getFilteredAssociates();

            return (
                <div className="setup-form">
                    <div className="form-section">
                        <h3>Manage Core Associates</h3>
                        <p style={{ color: '#6b7280', marginBottom: '12px', fontSize: '12px' }}>
                            Core associates are team members assigned to specific line leads. Tag them with skills and attributes.
                        </p>

                        {/* View Mode Toggle */}
                        <div className="view-mode-toggle">
                            <button
                                className={`view-mode-btn ${viewMode === 'byLead' ? 'active' : ''}`}
                                onClick={() => setViewMode('byLead')}
                            >
                                By Line Lead
                            </button>
                            <button
                                className={`view-mode-btn ${viewMode === 'all' ? 'active' : ''}`}
                                onClick={() => setViewMode('all')}
                            >
                                All Associates
                            </button>
                        </div>

                        {/* Search Box */}
                        {viewMode === 'all' && (
                            <input
                                type="text"
                                className="search-box"
                                placeholder="Search associates by name..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                        )}

                        {/* By Lead View */}
                        {viewMode === 'byLead' && (
                            <>
                                <div className="form-grid">
                                    <div className="form-group">
                                        <label>Select Existing Lead</label>
                                        <select
                                            value={selectedLead}
                                            onChange={(e) => {
                                                setSelectedLead(e.target.value);
                                                setNewLead('');
                                            }}
                                        >
                                            <option value="">-- Select Lead --</option>
                                            {allLeads.map(lead => (
                                                <option key={lead} value={lead}>{lead}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div style={{ textAlign: 'center', padding: '16px 0', color: '#6b7280' }}>OR</div>
                                    <div className="form-group">
                                        <label>New Lead Name</label>
                                        <input
                                            type="text"
                                            value={newLead}
                                            onChange={(e) => {
                                                setNewLead(e.target.value);
                                                setSelectedLead('');
                                            }}
                                            placeholder="Enter new lead name"
                                        />
                                    </div>
                                </div>

                                {(selectedLead || newLead) && (
                                    <div style={{ marginTop: '20px' }}>
                                        <div className="lead-header">
                                            <h4 className="lead-title">Core Associates for {selectedLead || newLead}</h4>
                                            {selectedLead && (
                                                <button
                                                    className="btn btn-danger btn-small"
                                                    onClick={() => onDeleteLineLead(selectedLead)}
                                                >
                                                    Delete Line Lead
                                                </button>
                                            )}
                                        </div>

                                        <form onSubmit={handleAddAssociate}>
                                            <div className="form-grid">
                                                <div className="form-group">
                                                    <label>Associate Name *</label>
                                                    <input
                                                        type="text"
                                                        value={newName}
                                                        onChange={(e) => setNewName(e.target.value)}
                                                        placeholder="Full name"
                                                        required
                                                    />
                                                </div>
                                                <div className="form-group">
                                                    <label>Flags / Skills</label>
                                                    <FlagsDropdown flags={newFlags} onChange={setNewFlags} inForm={true} />
                                                </div>
                                            </div>
                                            <button type="submit" className="btn btn-success">
                                                + Add Core Associate
                                            </button>
                                        </form>
                                    </div>
                                )}
                            </>
                        )}

                        {/* Filters and Sort */}
                        {((viewMode === 'byLead' && (selectedLead || newLead) && (coreAssociates[selectedLead || newLead] || []).length > 0) || (viewMode === 'all' && getAllAssociates().length > 0)) && (
                            <div className="filter-controls">
                                <div className="filter-row">
                                    <span className="filter-label">Sort by:</span>
                                    <select
                                        value={sortBy}
                                        onChange={(e) => setSortBy(e.target.value)}
                                        style={{ padding: '4px 8px', fontSize: '12px', borderRadius: '4px', border: '1px solid #d1d5db' }}
                                    >
                                        <option value="name">Name</option>
                                        {AVAILABLE_FLAGS.map(flag => (
                                            <option key={flag.id} value={flag.id}>{flag.label}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="filter-row" style={{ marginTop: '8px' }}>
                                    <span className="filter-label">Filter by flags:</span>
                                    {AVAILABLE_FLAGS.map(flag => (
                                        <label key={flag.id} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', cursor: 'pointer' }}>
                                            <input
                                                type="checkbox"
                                                checked={filterFlags.includes(flag.id)}
                                                onChange={(e) => {
                                                    if (e.target.checked) {
                                                        setFilterFlags([...filterFlags, flag.id]);
                                                    } else {
                                                        setFilterFlags(filterFlags.filter(f => f !== flag.id));
                                                    }
                                                }}
                                            />
                                            {flag.label}
                                        </label>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Associates List */}
                        {viewMode === 'byLead' ? (
                            // By Lead View
                            (selectedLead || newLead) && (
                                <div className="core-associates-list">
                                    {(coreAssociates[selectedLead || newLead] || []).length === 0 ? (
                                        <p style={{ color: '#6b7280', fontStyle: 'italic', fontSize: '12px' }}>
                                            No core associates yet for this lead.
                                        </p>
                                    ) : filteredAssociates.length === 0 ? (
                                        <p style={{ color: '#6b7280', fontStyle: 'italic', fontSize: '12px' }}>
                                            No associates match the selected filters.
                                        </p>
                                    ) : (
                                        filteredAssociates.map((associate, idx) => {
                                            const originalIndex = (coreAssociates[selectedLead || newLead] || []).findIndex(a => a.name === associate.name);
                                            return (
                                                <div key={idx} className="core-associate-item">
                                                    <div className="core-associate-info">
                                                        <div className="core-associate-name">{associate.name}</div>
                                                        <div className="core-associate-flags">
                                                            {associate.flags && associate.flags.length > 0 ? (
                                                                associate.flags.map(flagId => {
                                                                    const flag = AVAILABLE_FLAGS.find(f => f.id === flagId);
                                                                    return flag ? (
                                                                        <span key={flagId} className={`flag-badge ${flag.className}`}>
                                                                            {flag.label}
                                                                        </span>
                                                                    ) : null;
                                                                })
                                                            ) : (
                                                                <span style={{ fontSize: '11px', color: '#9ca3af', fontStyle: 'italic' }}>No flags</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '4px', flexDirection: 'column' }}>
                                                        <FlagsDropdown
                                                            flags={associate.flags || []}
                                                            onChange={(newFlags) => handleUpdateAssociateFlags(selectedLead || newLead, originalIndex, newFlags)}
                                                        />
                                                        <button
                                                            className="btn btn-danger btn-small"
                                                            onClick={() => onRemoveCoreAssociate(selectedLead || newLead, originalIndex)}
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            )
                        ) : (
                            // All Associates View
                            <div>
                                {allLeads.length === 0 ? (
                                    <p style={{ color: '#6b7280', fontStyle: 'italic', fontSize: '12px', textAlign: 'center', padding: '20px' }}>
                                        No line leads created yet. Switch to "By Line Lead" view to add your first lead and associates.
                                    </p>
                                ) : filteredAssociates.length === 0 ? (
                                    <p style={{ color: '#6b7280', fontStyle: 'italic', fontSize: '12px', textAlign: 'center', padding: '20px' }}>
                                        {searchQuery ? 'No associates match your search.' : 'No associates match the selected filters.'}
                                    </p>
                                ) : (
                                    allLeads.map(lead => {
                                        const leadAssociates = filteredAssociates.filter(a => a.lead === lead);
                                        if (leadAssociates.length === 0) return null;

                                        return (
                                            <div key={lead} className="lead-section">
                                                <div className="lead-header">
                                                    <h4 className="lead-title">{lead}</h4>
                                                    <button
                                                        className="btn btn-danger btn-small"
                                                        onClick={() => onDeleteLineLead(lead)}
                                                    >
                                                        Delete Lead
                                                    </button>
                                                </div>
                                                <div className="core-associates-list">
                                                    {leadAssociates.map((associate, idx) => (
                                                        <div key={idx} className="core-associate-item">
                                                            <div className="core-associate-info">
                                                                <div className="core-associate-name">{associate.name}</div>
                                                                <div className="core-associate-flags">
                                                                    {associate.flags && associate.flags.length > 0 ? (
                                                                        associate.flags.map(flagId => {
                                                                            const flag = AVAILABLE_FLAGS.find(f => f.id === flagId);
                                                                            return flag ? (
                                                                                <span key={flagId} className={`flag-badge ${flag.className}`}>
                                                                                    {flag.label}
                                                                                </span>
                                                                            ) : null;
                                                                        })
                                                                    ) : (
                                                                        <span style={{ fontSize: '11px', color: '#9ca3af', fontStyle: 'italic' }}>No flags</span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <div style={{ display: 'flex', gap: '4px', flexDirection: 'column' }}>
                                                                <FlagsDropdown
                                                                    flags={associate.flags || []}
                                                                    onChange={(newFlags) => handleUpdateAssociateFlags(associate.lead, associate.leadIndex, newFlags)}
                                                                />
                                                                <button
                                                                    className="btn btn-danger btn-small"
                                                                    onClick={() => onRemoveCoreAssociate(associate.lead, associate.leadIndex)}
                                                                >
                                                                    Remove
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        )}
                    </div>

                    {/* Firebase Connection Status Indicator */}
                    <div className="firebase-status">
                        <div className={`firebase-status-dot ${firebaseStatus}`}></div>
                        <span>
                            {firebaseStatus === 'connected' ? 'Cloud Connected' :
                             firebaseStatus === 'disconnected' ? 'Cloud Disconnected' :
                             'Offline Mode'}
                        </span>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
